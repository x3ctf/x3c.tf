<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>\x3C/script></title>
  <meta content="x3CTF 2025 (feat. mvm)" property="og:title" />
  <meta content="\x3C/script>" property="og:description" />
  <meta content="https://x3c.tf/" property="og:url" />
  <meta content="#0000AA" data-react-helmet="true" name="theme-color" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Geo:ital@0;1&display=block" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Lilita+One&display=block" rel="stylesheet">
	<link rel="icon" type="image/png" href="favicon.ico" />
	<style type="text/css">
		body,html {
			font-family: "Geo", monospace;
			color: #FFF;
			text-align: center;
			height: 80%;
		}
		body {
			background: #8BB056;
			overflow: hidden;
		}
		a {
			color: #FF0;
		}
		h1 {
			font-size: 72px;
			font-weight: 400;
			margin-bottom: 0;
			color: #FFF;
			background: #a0a;
		}
		#countdown {
			font-size: 32px;
			height:80%;
			vertical-align: center;
    		display: flex;
    		flex-direction: column;
    		align-content: center;
    		justify-content: center;
    		align-items: center;
		}
		.overlay {
			opacity: 0;
			position: fixed;
			user-select: none;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
		}
		#msgsOverlay {
			opacity: 0.4;
			filter: blur(2px);
			transition: 2s opacity, 2s filter;
			z-index: 5;
			&.active {
				filter: blur(0);
				opacity: 0.8;
			}
		}
		#intro_overlay {
			background: #000;
			z-index: 3;
		}
		.overlayMsg {
			position: absolute;
			/*color: #FFF;*/
			width: fit-content;
			white-space: nowrap;
			left: 0;
			user-select: none;
			pointer-events: none;
			translate: 200vw 0;
			transition: translate 16s linear, text-align 16s linear;

			@starting-style {
				text-align: left;
				translate: -100% 0;
  			}
		}

		h1, h2, h3 {
			margin: 0;
		}

		#graphics {
			fill: #FDF6B2;
			transform: skew(-9deg, -8deg);
			scale: 1;
			cursor: default;
			z-index: 3;
			& #title {
				font: 400 192px "Geo";
				transition: 2s letter-spacing cubic-bezier(0,0,0,1);
				letter-spacing: 0;

			}
			& #countdown {
				font: 400 64px "Geo";

			}

			transition: transform 3s cubic-bezier(0,0.3,0,1), scale 1s cubic-bezier(0,0,0,1);

		}
		.info {
			text-align: left;
			font-size: 1.5em;
			max-width: 600px;
			margin: auto;
			padding: 16px;
			background: #000;
			border: 2px solid #FFF;
			transform: skew(0deg, -7.75deg);
			&> div {
				transform: skew(0deg, 0deg);
			}
			&.nav > span {
				display: flex;
				gap: 8px;
				& div {
					cursor: pointer;
				}
			}
		}
		#graphicsBlock {
			display: flex;
			padding: 64px 0 96px;
			/* because Safari sucks */
			& > svg {
				width: 100%;
			}
		}

#mainContent {
	max-width: 800px;
	margin: auto;
	filter: none;
	transition: filter 0.2s cubic-bezier(0,0,0,1);
	&.active {
		& #loginBlock {
			filter: blur(10px);
			opacity: 1;
		}
		filter: blur(10px);
	}
	& *::selection {
		background: #FF0;
		color: #000;
		fill: #000;
	}
	/* ??? */
	overflow: hidden;
}

::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: #000; }
::-webkit-scrollbar-thumb { background: #FFF; }
::-webkit-scrollbar-thumb:hover { background: #FF0; }

		@media (prefers-reduced-motion) {
			#intro_overlay {
				display: none;
			}
			#msgsOverlay {
				display: none;
			}
			#graphics, #graphics #title {
				transition: none;
			}
			#graphics #countdown, #graphics #subtitle, .info {
				animation-name: none;
			}
		}

		/* ---- */
		body.smooth {
			transition: background 1s;
			& #graphics {
				transition: fill 1s;
			}
		}
		#mainContent {
			& .info {
				transition: opacity 1s cubic-bezier(0,0,0,1);
				opacity: 1;
			}
			& #graphicsBlock {
				height: auto;
				interpolate-size: allow-keywords;
				transition: padding 1s cubic-bezier(0,0,0,1), height 1s cubic-bezier(0,0,0,1);
			}
		}
		#mainContent.countdowning {
			& .info {
				opacity: 0;
			}
			& #graphics {
				transition: none;
			}
			& #graphicsBlock {
				padding: 0;
				height: 75vh;
			}
		}

		#intro_title {
			position: fixed;
			font: 400 200px "Cherry Bomb One", system-ui;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 15;
			user-select: none;

			& text {
				stroke-dasharray: 1000, 1000;
				fill: #0000;
				paint-order: stroke;
				stroke: #FFF;
				opacity: 100%;
  				stroke-width: 2px;
  				stroke-linecap: round;
  				stroke-linejoin: round;
				margin: auto;
				letter-spacing: 0;
			}
			&.thin text {
				stroke-width: 1px;
			}
			&.filled text {
				fill: #FFA1C3;
				stroke-width: 16px;
			}
		}
		#overlay1 {
			background: #000;
			z-index: 10;
		}
		#overlay2 {
			background: #FFF;
			z-index: 20;
		}
		#joinCountdown {
			opacity: 1;
			transition: 0.5s opacity cubic-bezier(0,0,0,1),
									0.5s height cubic-bezier(0,0,0,1);
   		translate: 0 -86px;
   		interpolate-size: allow-keywords;

			&.hidden {
				pointer-events: none;
				opacity: 0;
				height: 0;
			}

			& .btn {
				transform: skew(0deg, -7.75deg);
				background: #000;
				color: #FF0;
				border: 4px #FF0 solid;
				width: fit-content;
				margin: auto;
				padding: 8px 16px 12px;
				cursor: pointer;
				box-shadow: 1px 2px 6px 0 #FF0;
				font: 400 24px "Cherry Bomb One", system-ui;
				text-shadow: 2px 2px #0E162E;
				translate: 0 0;
				filter: brightness(1);
				transition: 
					0.5s filter cubic-bezier(0,0,0,1),
					0.5s translate cubic-bezier(0,0,0,1),
					0.5s box-shadow cubic-bezier(0,0,0,1);
				&:hover {
					translate: -2px -2px;
					box-shadow: 3px 4px 7px 0 #FF0;
					filter: brightness(1.05);
				}
				&:active {
					translate: 1px 1px;
					box-shadow: 0px 1px 0px 0 #FF0;
					filter: brightness(0.9);
				}
			}

			& .btnOld {
				border-radius: 64px;
				background: #FFA1C3;
				color: #FFF;
				width: fit-content;
				margin: auto;
				padding: 8px 16px 12px;
				cursor: pointer;
				box-shadow: 1px 2px 6px 0 #FFA1C3;
				font: 400 24px "Cherry Bomb One", system-ui;
				text-shadow: 2px 2px #0E162E;
				translate: 0 0;
				filter: brightness(1);
				transition: 
					0.5s filter cubic-bezier(0,0,0,1),
					0.5s translate cubic-bezier(0,0,0,1),
					0.5s box-shadow cubic-bezier(0,0,0,1);
				&:hover {
					translate: -1px -1px;
					box-shadow: 2px 3px 7px 0 #FFA1C3;
					filter: brightness(1.05);
				}
				&:active {
					translate: 1px 1px;
					box-shadow: 0px 1px 0px 0 #FFA1C3;
					filter: brightness(0.9);
				}
			}
		}
		#nowplaying {
			display: block;
			position: fixed;
			bottom: 16px;
			left: 0;
			right: 0;
			margin: 0 auto;
			width: fit-content;
			z-index: 50;
			transition: opacity 8s;
			& a {
				color: inherit;
				text-decoration: underline;
			}
		}

		.reducedMotion {
			display: none;
		}

		@media (prefers-reduced-motion) {
			#joinCountdown {
				transition: none;
				animation: none;
			}
			.reducedMotion {
				display: block;
			}
			#msgsOverlay {
				display: none;
			}
			body.smooth, #mainContent .info, #mainContent #graphicsBlock {
				transition: none;
			}
		}
	</style>
</head>
<body>
<div class="overlay" id="intro_overlay"></div>
<div id="nowplaying" style="opacity:0;display:none">now playing: <a target="_blank"></a></div>
<div id="mainContent">
	<div id="graphicsBlock">
		<svg id="graphics" viewBox="0 0 512 256">
  		<text x="50%" y="50%" id="title" dominant-baseline="middle" text-anchor="middle">x3CTF</text>
  		<text x="50%" y="77%" id="countdown" dominant-baseline="middle" text-anchor="middle">--:--:--.---</text>
  		<text x="50%" y="87.5%" id="subtitle" dominant-baseline="middle" text-anchor="middle">until x3CTF 2025 (feat. mvm)</text>
		</svg>
	</div>
	<div id="joinCountdown" class="hidden">
		<br>
		<div class="btn">Join the Countdown!</div>
		<p class="reducedMotion"><br>
			Not recommended with prefers-reduced-motion!<br>
			(you have it enabled on your system)<br><br>
			FYI: This setting also disables some cool animations and stuff on the platform.<br>
			See <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-reduced-motion#user_preferences">here</a> if you'd like to change the setting.
		</p>
	</div>
<div class="info nav">
	<span id="loggedOut"><div onclick="xD.login()">Login</div> | <div onclick="xD.login()/*document.location.href='https://idp.x3c.tf/if/flow/berg-enrollment/'*/">Register</div></span>
	<span id="loggedIn" style="display:none"><div style="cursor: default"></div> | <div onclick="xD.logout()">Logout</div></span>
</div>
<br>
<div class="info"><div>
<h2>About</h2>

<p>x3CTF is a cute little jeopardy-style CTF with web, pwn, rev, crypto, and misc challs!</p>

<p>x3CTF 2025 (feat. mvm) will run from Jan 24th 18:00 UTC until Jan 26th 18:00 UTC (48h). Be here a few minutes early for a fun surprise ^_^.</p>

<p>Check us out on <a href="https://ctftime.org/event/2467">CTFtime</a> and join our <a href="https://discord.gg/WpFHfD6nqH">Discord</a> server.</p>

<h2>Signups</h2>

<p>Sign up by simply registering an account for your team above, one account per team ;3.</p>

<h2>MVM</h2>

<p>We teamed up with mvm to accept community-submitted challenges for x3CTF. Challenge submissions have now been now closed, thank you for all the awesome contributions!</p>

<h2>Prizes</h2>

<p>List of prizes:</p>

<ul>
<li>iPad  </li>
<li>iPod  </li>
<li>iPhone  </li>
<li>Android phone for every person on the team (while supplies last)  </li>
<li>Thinkpad (with socks and cat ears)</li>
</ul>

<p>Prizes will be signed.</p>

<p>Each winning team will be able to pick one prize in scoreboard order. There will probably be alternate prizes for those who can't or wish not to receive a prize physically.</p>

<p>We reserve the right to not send out a physical prize if shipping it would be prohibitively difficult or expensive (<a href="https://www.omniva.ee/public/files/failid/hinnakiri-rv-pakiteenused-era-est-en-2024.pdf">shipping costs</a> over 50€ will be decided on a case-by-case basis).</p>

<p>We also have a Windows Phone and we honestly have no idea what to do with it.</p>

<h2>Rules</h2>

<ol>
<li>You are allowed to play either individually or with a team. When playing with a team, register and use a single account for the entire team. <br />
<ol>
<li>If playing on a team, you are allowed to also have 1 personal account to yourself, but you are not allowed to submit flags on it.  </li>
</ol></li>
<li>There is no bruteforce or scanning of public infrastructure required to solve the challenges.  </li>
<li>Attacking or abusing the organizers infrastructure is forbidden. <br />
Valid challenge targets are located at: <br />
<ol>
<li>https://&lt;UUID&gt;.x3c.tf​:1337  </li>
<li>https://&lt;UUID&gt;.x3c.tf​:31337  </li>
<li>instances.x3c.tf:30000-65535 (tcp/udp)  </li>
</ol></li>
<li>Don't share flags or discuss challenges outside of your team while the CTF is running. <br />
<ol>
<li>You are, of course, allowed to discuss the challenges and share solutions once the CTF has ended.  </li>
</ol></li>
<li>Community challenge authors (mvm) are allowed to participate in the CTF and even solve their own challenges. However, they (and their team) are not allowed first blood the challenges they contributed - they must wait for a different team to solve the challenge first.  </li>
<li>Have fun! <br />
<ol>
<li>Let others have fun too! We're an inclusive CTF and discrimination or harassment will not be tolerated.</li>
</ol></li>
</ol>

<p><em>Note: The rules are still being determined and may change before the CTF begins.</em></p>

<h2>Credits</h2>

<p>The x3CTF team consists of <a href="https://blog.gk.wtf/">Coderion</a>, <a href="https://dagurb.com">DagurB</a>, Raptor, rdx4.2, <a href="https://lyra.horse">Rebane</a>, and ShadowCone. <br />
We're using the Berg CTF Platform by <a href="https://norelect.ch/">NoRelect</a>, with a custom frontend by Rebane. <br />
Thank you to all the MVM contributors for submitting additional challenges: alex_hcsc, boxmein, hackrrr, joneswastaken, ksaweryr, musava_ribica, natan.p, and xtea418. <br />
Music: ??? (surprise!)</p>
</div></div>
<br>
<div class="info">
2025 nya~
</div>
<div style="height:64px"></div>
</div>
<div class="overlay" id="msgsOverlay"></div>

<!-- -->
<svg id="intro_title" style="display:none" class="thin" viewBox="0 0 850 100">
  <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">x3CTF</text>
</svg>
<div class="overlay" id="overlay1"></div>
<div class="overlay" id="overlay2"></div>
<script>
	// ARCHIVE LOGIN UTILS
	window.xD = (() => {
		async function login() {
			document.location.href = "archive-login.html#intro.html";
		}
		async function logout() {
			document.location.href = "archive-logout.html#intro.html";
		}
		return {login, logout};
	})();

	// ARCHIVE WS PLAYBACK
	let wsLog = [];
	let wsLogIdx = 0;
	fetch("intro_ws_replay.jsonl").then(r=>r.text()).then(r=>wsLog=r.split("\n").map(e=>JSON.parse(e)));

	function replay_ws() {
		if (!wsLog.length) return;
		const currentWsTime = getOffsetTime(true) - TARGET_TIME + 1737741600*1000;
		while (wsLogIdx && wsLog[wsLogIdx-1]["time"] > currentWsTime) wsLogIdx--;
		while (wsLog.length > wsLogIdx && wsLog[wsLogIdx]["time"] < currentWsTime) {
			const e = wsLog[wsLogIdx];
			wsLogIdx++;
	  		if (e.data.startsWith("uwu")) {
	  			if (wsLog[wsLogIdx]["time"] > currentWsTime - 1000)
	  				newDcMsg(e.data.slice(4));
	  		} else {
  				const [_w1, site_ver, _w2, current_time, mvm] = e.data.split(" ");
  				if (mvm !== "mvm") {
  					preloadCtfData(mvm);
  				}
  			}
	  }
	}


    // funny rebane oidc library
    /*
    // DISABLED FOR ARCHIVED VERSION
    window.xD = (() => {
        const REDIRECT_URI = "https://x3c.tf/";
        const LOGOUT_URI = "https://idp.x3c.tf/if/flow/default-invalidation-flow/";
        const CLIENT_ID = "berg-client";
        const PRE = "uwu";
        let refreshTimeout;

        async function bufferToBase64(buffer) {
          const base64url = await new Promise(r => {
            const reader = new FileReader()
            reader.onload = () => r(reader.result)
            reader.readAsDataURL(new Blob([buffer]))
          });
          return base64url.slice(base64url.indexOf(',') + 1);
        }
    
        function cryptoHex(bytes) {
            return Array.from(crypto.getRandomValues(new Uint8Array(bytes)))
                .map(b => b.toString(16).padStart(2, '0')).join('');
        }
    
        async function login() {
            const state = cryptoHex(16);
            const code_verifier = cryptoHex(32);
            const code_verifier_enc = new TextEncoder().encode(code_verifier);
            const hashBuffer = await crypto.subtle.digest('SHA-256', code_verifier_enc);
            const code_challenge = (await bufferToBase64(new Uint8Array(hashBuffer))).replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
    
            localStorage.setItem(`${PRE}-state`, state);
            localStorage.setItem(`${PRE}-verifier`, code_verifier);
    
            const params = {
                "client_id": CLIENT_ID,
                "redirect_uri": REDIRECT_URI,
                "response_type": "code",
                "scope": "openid offline_access",
                "state": state,
                "code_challenge": code_challenge,
                "code_challenge_method": "S256",
                "response_mode": "query",
            };
            document.location = `/api/openid/authorize?${new URLSearchParams(params)}`;
        }
    
        async function logout() {
            localStorage.removeItem(`${PRE}-refresh`);
            await fetch("https://x3c.tf/api/openid/end-session");
            document.location.href = LOGOUT_URI;
        }
    
        async function fetchAccessToken(code = null) {
            const params = code ? {
                "client_id": CLIENT_ID,
                "code": code,
                "redirect_uri": REDIRECT_URI,
                "code_verifier": localStorage.getItem(`${PRE}-verifier`),
                "grant_type": "authorization_code",
            } : {
                "client_id": CLIENT_ID,
                "refresh_token": localStorage.getItem(`${PRE}-refresh`),
                "grant_type": "refresh_token",
            };
            try {
                const resp = await fetch("/api/openid/token", {
                      "headers": { "content-type": "application/x-www-form-urlencoded" },
                      "body": new URLSearchParams(params),
                      "method": "POST",
                    });
                const {access_token, refresh_token, expires_in} = await resp.json();
                if (refreshTimeout)
                    clearTimeout(refreshTimeout);
                refreshTimeout = setTimeout(() => fetchAccessToken(), expires_in*1000);
                localStorage.setItem(`${PRE}-refresh`, refresh_token);
                localStorage.setItem(`${PRE}-access`, access_token);
                localStorage.setItem(`${PRE}-expires`, Math.floor(Date.now()/1000 + expires_in));
                return access_token;
            } catch (e) {
                // idk some error, token probably expired
                console.error(e);
                localStorage.removeItem(`${PRE}-refresh`);
            }
        }

        async function getAccessToken() {
            const refresh_token = localStorage.getItem(`${PRE}-refresh`);
            if (!refresh_token || refresh_token === "undefined") return localStorage.removeItem(`${PRE}-refresh`);
            const expires_at = parseInt(localStorage.getItem(`${PRE}-expires`, 0));
            if (!isNaN(expires_at) && Date.now()/1000 < expires_at) return localStorage.getItem(`${PRE}-access`);
            return await fetchAccessToken();
        }

        async function getHeader() {
            const access_token = await getAccessToken();
            return access_token ? {"Authorization": `Bearer ${access_token}`} : {};
        }
        
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = localStorage.getItem(`${PRE}-state`);
            if (state && urlParams.get("state") === state) {
                const code = urlParams.get("code");
                if (code) {
                    history.pushState({}, "", "?");
                    localStorage.removeItem(`${PRE}-state`);
                    await fetchAccessToken(code);
                }
            }
        }

        return {init, login, logout, getHeader, getAccessToken};
    })();
    */

	const PRE_WS_ENDPOINT = "wss://x3c.tf/irc/";
	const PRE_SITE_VER = 3;
	let prefers_reduced = getPrefersReducedMotion();
	let TARGET_TIME = Date.now() + 1000*60*4; // 1737741600*1000;
	let time_offset = null;
	let C_DEBUG_MODE = false;

	let countdownIsRunning = false;
	let nextSiteHtml = "";

	const graphicsBlock = document.getElementById("graphicsBlock");
	const msgsOverlay = document.getElementById("msgsOverlay");
	const countdown = document.getElementById("countdown");
	const graphics = document.getElementById("graphics");
	const joinCountdown = document.getElementById("joinCountdown");
	const countdownTime = document.getElementById("countdown");
	const intro_title = document.getElementById("intro_title");
	const overlay1 = document.getElementById("overlay1");
	const overlay2 = document.getElementById("overlay2");
	const nowplaying = document.getElementById("nowplaying");
	const ae100 = bazierEase({x:0.16666, y:0.16666,}, {x:0, y:1,});
	const ae100r = (t) => 1-ae100(1-t);

function newDcMsg(msg) {
	const msgEl = document.createElement("div");
	msgEl.innerText = msg;
	msgEl.classList.add("overlayMsg");
	msgEl.style.fontSize = ((msg.length < 12 ? 20 : 16) + (Math.random()*8)) + "px";
	msgEl.style.top = (Math.random()*100) + "vh";
	msgsOverlay.appendChild(msgEl);
	setTimeout(()=>msgEl.remove(), 16000);
	// console.log(msg.replace(/%/g, '%%'));
}

function setTimeOffset(time) {
	time_offset = Date.now() - time;
}

function getOffsetTime(canFallback = false) {
	canFallback = true;
	if (time_offset === null) return canFallback ? Date.now() : 0;
	return Date.now() - time_offset;
}

function getPrefersReducedMotion() {
	const mediaQuery = window?.matchMedia?.('(prefers-reduced-motion: reduce)');
	mediaQuery?.addEventListener?.('change', () => {
	  prefers_reduced = mediaQuery.matches;
	});
	return mediaQuery?.matches;
}

// https://stackoverflow.com/a/23176223
// DISABLED FOR ARCHIVED VERSION
/*
function ws_connect() {
  const ws = new WebSocket(PRE_WS_ENDPOINT);
  ws.onopen = () => ws.send("nya~");

  ws.onmessage = function(e) {
  	if (e.data.startsWith("uwu")) {
  		newDcMsg(e.data.slice(4));
  	} else {
  		const [_w1, site_ver, _w2, current_time, mvm] = e.data.split(" ");
  		if (parseInt(site_ver) > PRE_SITE_VER) {
  			document.location.reload();
  		}
  		setTimeOffset(parseInt(current_time));
  		if (mvm !== "mvm") {
  			preloadCtfData(mvm);
  		}
		setTimeout(() => ws.send("meow"), 10000);
  	}
  };

  ws.onclose = function(e) {
    console.log('Socket closed, reconnecting... ', e.reason);
    setTimeout(() => ws_connect(), 1000);
  };

  ws.onerror = function(err) {
    console.error('Socket error: ', err.message, 'Closing socket');
    ws.close();
  };
};
*/

function animate() {
	try { replay_ws(); } catch (e) { console.error(e); }
	if (TARGET_TIME - Date.now() < 1000*60) TARGET_TIME += 1000*60*8;

	const timeLeft = (TARGET_TIME-getOffsetTime(true))/1000;
	const timeSplit = [Math.floor(timeLeft/24/60/60), (timeLeft/60/60)%24, (timeLeft/60)%60, timeLeft%60, timeLeft%1];
	const timeText = 
		(timeSplit[0] ? (`${timeSplit[0]}:`) : ``) +
		timeSplit.slice(1,4).map(t => String(Math.floor(t)).padStart(2,"0")).join(":") +
		((timeSplit[0] || prefers_reduced) ? "" : ("." + String(timeSplit[4]).slice(2,5).padEnd(3,"0")));
	countdownTime.textContent = timeText;
  	if (!countdownIsRunning && timeLeft < 600 && getOffsetTime())
  		joinCountdown.classList.remove("hidden");
	if (timeLeft <= (countdownIsRunning ? -5 : 0) && nextSiteHtml.length) {
		loadNextPage();
		return;
	}
	try {
		if (countdownIsRunning)
			if (animateCool()) return;
	} catch (e) {
		console.error(e);
	}
	requestAnimationFrame(animate);
}

let SONG_BPM = 128;

function beat2time(beat, bpm=SONG_BPM) {
    return beat/(bpm/60.);
}

function time2beat(t, bpm=SONG_BPM) {
    return (t)*(bpm/60.);
}

function trimIntroTitlePath(t) {
	const text = intro_title.querySelector("text");
	text.style.strokeDasharray = 595*t + " 1000";
	text.style.strokeDashoffset = -100*(1-t);
}

//https://stackoverflow.com/a/69190644
function executeScriptElements(containerElement) {
  const scriptElements = containerElement.querySelectorAll("script");

  Array.from(scriptElements).forEach((scriptElement) => {
    const clonedElement = document.createElement("script");

    Array.from(scriptElement.attributes).forEach((attribute) => {
      clonedElement.setAttribute(attribute.name, attribute.value);
    });
    
    clonedElement.text = scriptElement.text;

    scriptElement.parentNode.replaceChild(clonedElement, scriptElement);
  });
}

// TODO: store username/id in localstorage the same way as site does

let dataPreloadStarted = false;
async function preloadCtfData(mvm) {
	if (dataPreloadStarted) return;
	dataPreloadStarted = true;
	fetch(`${mvm}/index.html${C_DEBUG_MODE ? `?${Math.random()}` : ""}`).then(e=>e.text()).then(e=>nextSiteHtml=e).catch(setTimeout(() => preloadCtfData(mvm), 10000));
	window.preCtfData = await (await fetch(`${mvm}/swag.json`)).json();
}

function loadNextPage() {
			document.documentElement.innerHTML = nextSiteHtml;
			document.documentElement.style.cursor = '';
			executeScriptElements(document.documentElement);
}

function doBounce(currentBeat, thBeat, amount=2, easeFun=easeOutExpo) {
	if (thBeat == 0 || currentBeat < 0) return graphicsBlock.style.scale = "1";
	const t = (currentBeat/thBeat) % 1;
	const tE = easeFun(t);
	graphicsBlock.style.scale = `${1 + (1-tE)*amount/100}`;
}
function doSmoke(currentBeat, thBeat, color="255,255,255") {
	if (thBeat == 0 || currentBeat < 0) return graphicsBlock.style.filter = "none";
	const t = (currentBeat/thBeat) % 1;
	const tE = easeOutExpo(t);
	graphicsBlock.style.filter = `drop-shadow(0 0 ${tE*36}px rgba(${color},${1-t}))`;
}
function duotone(bg, fg) {
	document.body.style.background = bg;
	graphics.style.fill = fg;
	nowplaying.style.color = fg;
	msgsOverlay.style.color = fg;
}

	function animateCool(){
		let currentTime = getOffsetTime();

		const timeLeft = (TARGET_TIME-currentTime)/1000;

		if (timeLeft <= 0 && nextSiteHtml.length) {
			loadNextPage();
			return true;
		}


		const targetAudioTime = 600-timeLeft;

		const parts = [
			{
				name: "",
				link: "",
				start: 0,
				bpm: 160,
				beatOff: 0,
			},
			{
				name: "charlotte - last friday night wip",
				link: "https://soundcloud.com/char-lt/last-friday-night-wip",
				start: 34.13,
				bpm: 160,
				beatOff: 2,
			},
			{
				name: "user-177606668 - A Minute Or 2",
				link: "https://soundcloud.com/user-177606668/a-minute-or-2-user-is-back-3?",
				start: 2*60+46.12,
				bpm: 198,
				beatOff: 0,
			},
			{
				name: "SiIvaGunner - SIGN A SONG ABOUT HOPES AND DREAMS",
				link: "https://www.youtube.com/watch?v=YnDOKUZY2sU",
				start: 4*60+52.70,
				bpm: 145,
				beatOff: 32,
			},
			{
				name: "Britney Spears - Toxic (charlotte athena bootleg)",
				link: "https://soundcloud.com/char-lt/toxic",
				start: 7*60+22.08,
				bpm: 143,
				beatOff: 1,
			},
			{
				name: "Vylet Pony - Girls Who Are Wizards",
				link: "https://vyletpony.bandcamp.com/track/girls-who-are-wizards",
				start: 9*60+1.30,
				bpm: SONG_BPM, // 128
				beatOff: 0,
			},
		];

		const currentPartIdx = parts.findLastIndex(e => e.start <= targetAudioTime) ?? 0;
		const currentPart = parts[currentPartIdx];

		nowplaying.querySelector("a").innerText = currentPart.name;
		nowplaying.querySelector("a").href = currentPart.link;

		if (currentPartIdx == 0) {
			duotone("#23003E", "#DCD8FF");
		}

		if (currentPartIdx > 0 && currentPartIdx < 5) {
			const currentBeat = time2beat(targetAudioTime-currentPart.start, currentPart.bpm) - currentPart.beatOff;
			nowplaying.style.opacity = "1";
			//document.body.style.background = Math.floor(currentBeat % 2) ? "red" : "yellow";

			switch (currentPartIdx) {
				case 1:
					duotone("#8A006B", "#FFF");
					/*
					if (currentBeat <= 8*4) {
						doSmoke(currentBeat, 8);
					} else if (currentBeat <= 16*4) {
						//doBounce(currentBeat, 1, 3);
						doSmoke(currentBeat, 8);
					} else if (currentBeat <= 40*4) {
						doSmoke(currentBeat, 8);
					} else {

					}*/
					//doBounce(currentBeat, 8, 2);
					//doSmoke(currentBeat, 8);
					break;
				case 2:
					//duotone("#007DB1", "#FFD200");
					duotone("#71CC83", "#C5FEB2");
					//doBounce(currentBeat, 1, 0.5);
					if (currentBeat >= 104*4) break;
					doBounce(currentBeat, 8, 2);
					doSmoke(currentBeat, 16);
					break;
				case 3:
					//duotone("#CDE96E", "#FF85E7");
					//duotone("#FDF6B2", "#FB80FF");
					//duotone("#F3B8D1", "#FDF6B2");
					//duotone("#A0B056", "#FDF6B2");
					//duotone("#463770", "#FDF6B2");
					duotone("#8BB056", "#FDF6B2");
					
					// 0 | 24 | 32 | 36 | 40
					if (currentBeat <= 32*4-32) {
						//doBounce(currentBeat, 4, 2);
						doBounce(currentBeat, 8, 2);
						//doSmoke(currentBeat, 8);
					} else if (currentBeat <= 36*4-32) {

					} else if (currentBeat <= 40*4-32) {
						//doSmoke(currentBeat, 4);
					} else if (currentBeat <= 48*4-32) {
						doBounce(currentBeat, 1, 1);
						//doSmoke(currentBeat, 4);
					} else if (currentBeat <= 50*4-32) {

					} else if (currentBeat <= 58*4-32) {
						doBounce(currentBeat, 0.5, 0.5);
						//doSmoke(currentBeat, 4);
					} else if (currentBeat <= 66*4-32) {
						doBounce(currentBeat, 4, 2);
						//doSmoke(currentBeat, 4);
					} else if (currentBeat <= 68*4-32) { // -1

					} else if (currentBeat <= 82*4-32-1) { // -1
						doBounce(currentBeat, 1, 1);
						//doSmoke(currentBeat, 4);
					} else {

					}
					break;
				case 4:
					//duotone("#5DD771", "#BDFFB2");
					duotone("#463770", "#FF4FB2");
					if (currentBeat >= 59*4-4) break;
					doBounce(currentBeat, 1, 0.5);
					doSmoke(currentBeat, 8, "255,79,178");
					break;
				default:
					doBounce(currentBeat, 1, 1);
					doSmoke(currentBeat, 8);
					break;
			}

			
			const currentTimeOrTimeLeft = (Math.abs(targetAudioTime-targetAudioTime) < 0.5) ? (600-targetAudioTime) : timeLeft;
			const syncPostMult = 4*Math.floor(Math.max((62-timeLeft)*4,1));
			const timeLeftSync = 600-(beat2time(Math.floor(syncPostMult*time2beat((600-currentTimeOrTimeLeft)-currentPart.start, currentPart.bpm))/syncPostMult, currentPart.bpm)+currentPart.start);
			const timeSplit = [Math.floor(timeLeftSync/24/60/60), (timeLeftSync/60/60)%24, (timeLeftSync/60)%60, timeLeftSync%60, timeLeftSync%1];
			const timeText = 
				timeSplit.slice(1,4).map(t => String(Math.floor(t)).padStart(2,"0")).join(":") +
				((timeSplit[0] || prefers_reduced) ? "" : ("." + String(timeSplit[4]).slice(2,5).padEnd(3,"0")));
			countdownTime.textContent = timeText;
		}



		if (currentPartIdx === 5) {

			// reset
			graphicsBlock.style.filter = "none";
			graphicsBlock.style.scale = `1`;
			graphics.style.fill = "#FFF";
			nowplaying.style.color = "#FFF";
			msgsOverlay.style.color = "#FFF";
			// reset

		const t = timeLeft/60;
		const tL2 = timeLeft/55;

		if (timeLeft < 48) {
			document.body.classList.remove("smooth");
			nowplaying.style.opacity = "0";
		}

		const PERIOD_1 = beat2time(8);
		const PERIOD_2 = beat2time(4);
		const PERIOD_3 = beat2time(1);

		if (timeLeft<PERIOD_1+10 && timeLeft >= PERIOD_1) {
			const fT = easeInExpo(1-(timeLeft-PERIOD_1)/10);
			graphics.style.transform = `skew(-${9*(1-fT)}deg, -${8*(1-fT)}deg) scale(${1-fT*0.85})`;
		}

		
		if (timeLeft<PERIOD_1) {
			const zT = (timeLeft-PERIOD_3)/(PERIOD_1-PERIOD_3);
			trimIntroTitlePath(1-Math.pow(1-Math.min(1,1-zT),1.2));
			intro_title.style.display = "block";
			if (timeLeft>PERIOD_2) {
				const xT = (timeLeft-PERIOD_2)/(PERIOD_1-PERIOD_2);
				intro_title.style.scale = 2.5;
				intro_title.style.translate = `${50+ae100r(xT)*10}% 25%`;
			} else {
				const xT = (timeLeft-PERIOD_3)/(PERIOD_2-PERIOD_3);
				intro_title.classList.remove("thin");
				intro_title.style.translate = `0% 0%`;
				intro_title.style.scale = 0.9 + ae100r(xT)*0.2;
				if (xT < 0) {
					intro_title.style.scale = 0.9 + ae100r(1-timeLeft/PERIOD_3)*0.2;
					overlay2.style.opacity = ae100r(1-timeLeft/PERIOD_3)*1;
				}
			}
			if (timeLeft < beat2time(1)) {
				const beat8 = Math.floor(time2beat(timeLeft)*8);
				if (beat8 % 2 < 1) {
					intro_title.classList.add("filled");
				} else {
					intro_title.classList.remove("filled");
				}
			}
		} else if (timeLeft<(PERIOD_1+1)) {
			const zT = (timeLeft-PERIOD_1);
			overlay1.style.opacity = easeOutQuint(1-zT);
			if (zT > 0.5) {
				if (document.title != "‎") {
    				document.title = "‎";
    				document.querySelector("link[rel~='icon']").href = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="
    				document.documentElement.style.cursor = 'none';
				}
			}
		}

		document.body.style.background = `rgb(0,0,${170*Math.max(0,Math.min(t-0.2,1))})`;
		document.getElementById("title").style.opacity = (Math.max(0,Math.min(t-0.15,1))*100) + "%";
		document.getElementById("subtitle").style.opacity = (Math.max(0,Math.min(t-0.35,1))*100) + "%";
		}

	}

	joinCountdown.querySelector(".btn").onclick = () => {
		startCountdown();
	}
	
	function startCountdown() {

		countdownIsRunning = true;
		document.querySelector("#mainContent").classList.add("countdowning");
		msgsOverlay.classList.add("active");
		document.body.style.overflow = "hidden";
		nowplaying.style.display = "block";
		document.body.classList.add("smooth");
		window.scrollTo(0, 0);
		joinCountdown.classList.add("hidden");
		
		setTimeout(() => {
			const timeLeft = (TARGET_TIME-Date.now())/1000;
			document.querySelector("#mainContent").classList.add("final");
		}, (TARGET_TIME-Date.now())-17500);
	}

function easeOutQuint(x) {
	return 1 - Math.pow(1 - x, 5);
}
function easeInExpo(x) {
return x === 0 ? 0 : Math.pow(2, 10 * x - 10);
}
function easeOutExpo(x) {
return x === 1 ? 1 : 1 - Math.pow(2, -10 * x);
}
// https://stackoverflow.com/a/77918525/2251833
function bazierEase(p1, p2) {
    const arr = [0,];
    const stepArr = 0.05;
    const stepBaz = 0.05;
    const baz = bezierEase0(p1, p2);
    let [prevBaz, nextBaz, tBaz,] = [{ x: 0, y: 0, }, baz(stepBaz), stepBaz,];
    for (let x = stepArr; x <= 1 - stepArr / 2; x += stepArr) {
        while (x > nextBaz.x && tBaz < 2) {
            prevBaz = nextBaz;
            tBaz += stepBaz;
            nextBaz = baz(tBaz);
        }
        arr.push(linInp(x, prevBaz.x, nextBaz.x, prevBaz.y, nextBaz.y));
    }
    arr.push(1);

    return (fraction) => {
        const iLeft = Math.min(Math.max(Math.floor(fraction / stepArr), 0), arr.length - 2);
        return linInp(fraction, iLeft * stepArr, (iLeft + 1) * stepArr, arr[iLeft], arr[iLeft + 1]);
    };

    function linInp(x, xFrom, xTo, yFrom, yTo) { return (x - xFrom) / (xTo - xFrom) * (yTo - yFrom) + yFrom; }

    // https://stackoverflow.com/questions/16227300, https://github.com/gre/bezier-easing/blob/master/src/index.js
    function bezierEase0(p1, p2) {
        const cX = 3 * p1.x;                            // const cX = 3 * (p1.x - p0.x);
        const cY = 3 * p1.y;                            // const cY = 3 * (p1.y - p0.y);
        const bX = 3 * (p2.x - p1.x) - cX;              // const bX = 3 * (p2.x - p1.x) - cX;
        const bY = 3 * (p2.y - p1.y) - cY;              // const bY = 3 * (p2.y - p1.y) - cY;
        const aX = 1 - cX - bX;                         // const aX = p3.x - p0.x - cX - bX;
        const aY = 1 - cY - bY;                         // const aY = p3.y - p0.y - cY - bY;
        return (t) => {
            const x = ((aX * t + bX) * t + cX) * t;     // const x = ((aX * t + bX) * t + cX) * t + p0.x;
            const y = ((aY * t + bY) * t + cY) * t;     // const y = ((aY * t + bY) * t + cY) * t + p0.y;
            return { x, y, };
        };
    }
}

async function checkLogin() {
	try {
		// CHANGED FOR ARCHIVED VERSION
		/*
		const playerData = (await (await fetch("/api/v2/players/current", {"headers": await xD.getHeader()})).json());
		document.querySelector("#loggedIn > div").innerText = playerData.name;
		document.querySelector("#loggedOut").style.display = "none";
		document.querySelector("#loggedIn").style.display = "";
		localStorage.setItem("x3c-username", playerData?.name);
		localStorage.setItem("x3c-userid", playerData?.id);
		*/
		const username = localStorage.getItem("x3c-username");
		if (username && username !== "undefined") {
			document.querySelector("#loggedIn > div").innerText = username;
			document.querySelector("#loggedOut").style.display = "none";
			document.querySelector("#loggedIn").style.display = "";
		}
	} catch {}
}

window.onload = async () => {
	// DISABLED FOR ARCHIVED VERSION
	animate();
	startCountdown();
	// ws_connect();
	// await xD.init();
};
</script>
</body>
</html>